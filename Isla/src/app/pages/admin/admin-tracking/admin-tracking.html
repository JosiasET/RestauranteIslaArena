<div class="admin-tracking-container">
  <!-- Header -->
  <div class="admin-header">
    <h1>ğŸ“¦ Barra de Pedidos</h1>
    <p>GestiÃ³n visual de pedidos</p>
  </div>

  <!-- Filtros principales -->
  <div class="quick-filters">
    <button class="filter-btn active" 
            (click)="setActiveView('active')"
            [class.active]="activeView === 'active'">
      â³ Pedidos Activos ({{ getActiveOrdersCount() }})
    </button>
    
    <button class="filter-btn finalizados-btn" 
            (click)="setActiveView('completed')"
            [class.active]="activeView === 'completed'">
      ğŸ Finalizados ({{ stats.finalizados }})
    </button>
  </div>

  <!-- Vista de pedidos activos -->
  <div *ngIf="activeView === 'active'" class="active-orders-section">    
    <!-- Barra de bÃºsqueda -->
    <div class="search-controls">
      <div class="search-box">
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="filterOrders()"
          placeholder="ğŸ” Buscar por cÃ³digo, cliente o telÃ©fono..."
          class="search-input"
        >
      </div>
      <button class="refresh-btn" (click)="loadOrders()" [disabled]="loading">
        {{ loading ? 'ğŸ”„ Cargando...' : 'ğŸ”„ Actualizar' }}
      </button>
    </div>

    <!-- Sub-filtros -->
    <div class="sub-filters">
      <button class="sub-filter-btn" 
              (click)="filterByStatus('en_proceso')"
              [class.active]="currentFilter === 'en_proceso'">
        ğŸ‘¨â€ğŸ³ En Proceso ({{ stats.en_proceso }})
      </button>
      <button class="sub-filter-btn" 
              (click)="filterByStatus('en_camino')"
              [class.active]="currentFilter === 'en_camino'">
        ğŸšš En Camino ({{ stats.en_camino }})
      </button>
      <button class="sub-filter-btn" 
              (click)="filterByStatus('entregados')"
              [class.active]="currentFilter === 'entregados'">
        âœ… Entregados ({{ stats.entregados }})
      </button>
    </div>

    <!-- Grid de pedidos ORGANIZADO -->
    <div class="orders-grid">
      
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando pedidos activos...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && filteredOrders.length === 0" class="empty-state">
        <div class="empty-icon">ğŸ“¦</div>
        <h3>No hay pedidos activos</h3>
        <p *ngIf="currentFilter">No se encontraron pedidos con el filtro "{{ getCurrentFilterText() }}"</p>
        <p *ngIf="!currentFilter && searchTerm">No se encontraron pedidos para "{{ searchTerm }}"</p>
        <p *ngIf="!currentFilter && !searchTerm">No hay pedidos en proceso en este momento</p>
        <button class="btn-refresh" (click)="loadOrders()">ğŸ”„ Actualizar</button>
      </div>

      <!-- Tarjetas de pedido ORGANIZADAS -->
      <div *ngIf="!loading && filteredOrders.length > 0" class="orders-grid-content">
        
        <!-- TODAS LAS CARDS JUNTAS -->
        <div *ngFor="let order of filteredOrders" 
     class="order-card"
     [class.online-card]="getOrderType(order) === 'takeaway'"
     [class.mesa-card]="getOrderType(order) === 'eat_in'"
     [class]="getOrderCardClass(order)"
     (click)="openOrderDetails(order)">
          
          <!-- Header -->
          <div class="card-header">
            <div class="order-code">{{ order.tracking_code }}</div>
            <div class="order-time">{{ getTimeAgo(order.order_date) }}</div>
            <div class="order-type-badge" 
                 [class.online]="getOrderType(order) === 'takeaway'"
                 [class.mesa]="getOrderType(order) === 'eat_in'">
              {{ getOrderTypeText(order) }}
            </div>
          </div>

          <!-- Cliente -->
          <div class="customer-info">
            <div class="customer-name">ğŸ‘¤ {{ order.customer_name }}</div>
            <div class="customer-phone">ğŸ“ {{ order.customer_phone || 'Sin telÃ©fono' }}</div>
          </div>

          <!-- InformaciÃ³n especÃ­fica segÃºn tipo -->
          <div *ngIf="getOrderType(order) === 'takeaway' && (getDeliveryAddress(order).neighborhood || getDeliveryAddress(order).city)" 
               class="address-preview">
            ğŸ“ {{ getDeliveryAddress(order).neighborhood || getDeliveryAddress(order).city }}
          </div>

          <div *ngIf="getOrderType(order) === 'eat_in'" class="table-info">
            ğŸ½ï¸ {{ getTableInfo(order) }}
          </div>

          <!-- Estado -->
          <div class="order-status">
            <span [class]="'status-badge ' + getStatusBadgeClass(order.status)">
              {{ getStatusText(order.status) }}
            </span>
          </div>

          <!-- InformaciÃ³n de pago -->
          <div class="payment-info">
            <div class="payment-method">{{ getPaymentMethodText(order.payment_method) }}</div>
            <div class="payment-status" 
                 [class.verified]="order.payment_verified" 
                 [class.pending]="!order.payment_verified">
              {{ order.payment_verified ? 'âœ… Verificado' : 'â³ Pendiente' }}
            </div>
          </div>

          <!-- Total y informaciÃ³n de efectivo -->
          <div class="amount-info">
            <div class="total-amount">ğŸ’° ${{ order.total_amount | number:'1.2-2' }}</div>
            
            <div *ngIf="order.payment_method === 'efectivo'" class="cash-info">
              <div class="cash-details">
                <div class="cash-amount">
                  {{ getOrderType(order) === 'eat_in' ? 'ğŸ’µ Recibido:' : 'ğŸ’µ Paga con:' }} 
                  ${{ getCashAmount(order) | number:'1.2-2' }}
                </div>
                <div class="change-amount" 
                    [class.exact]="getChangeAmount(order) === 0"
                    [class.positive]="getChangeAmount(order) > 0"
                    [class.negative]="getChangeAmount(order) < 0">
                  ğŸ”„ Cambio: ${{ getChangeAmount(order) | number:'1.2-2' }}
                </div>
              </div>
            </div>
          </div>

          <!-- Productos -->
          <div class="products-preview">
            <div *ngFor="let item of getOrderItems(order).slice(0, 2)" class="product-preview">
              <span class="product-name">{{ item.nombre }}</span>
              <span class="product-quantity">x{{ item.cantidad }}</span>
            </div>
            <div *ngIf="getOrderItems(order).length > 2" class="more-items">
              +{{ getOrderItems(order).length - 2 }} mÃ¡s...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de pedidos finalizados -->
  <div *ngIf="activeView === 'completed'" class="completed-orders-section">
    <div class="completed-header">
      <h2>ğŸ“‹ Historial de Pedidos Finalizados</h2>
      <p>Respaldo de pedidos completados - Solo consulta</p>
    </div>

    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando pedidos finalizados...</p>
    </div>

    <div *ngIf="!loading" class="completed-orders-list">
      <div *ngFor="let order of completedOrders" class="completed-order-item">
        <div class="completed-order-info">
          <div class="completed-order-main">
            <div class="completed-order-code">{{ order.tracking_code }}</div>
            <div class="completed-order-customer">{{ order.customer_name }}</div>
            <div class="completed-order-type">{{ getOrderTypeText(order) }}</div>
          </div>
          <div class="completed-order-details">
            <div class="completed-order-date">{{ getTimeAgo(order.order_date) }}</div>
            <div class="completed-order-total">${{ order.total_amount | number:'1.2-2' }}</div>
          </div>
        </div>
        <div class="completed-order-actions">
          <button class="btn-view-details" (click)="openOrderDetails(order)">
            ğŸ‘ï¸ Ver Detalles
          </button>
        </div>
      </div>

      <div *ngIf="completedOrders.length === 0" class="empty-completed">
        <div class="empty-icon">ğŸ“­</div>
        <h3>No hay pedidos finalizados</h3>
        <p>Los pedidos marcados como "Finalizado" aparecerÃ¡n aquÃ­ para consulta histÃ³rica</p>
        <button class="btn-refresh" (click)="loadCompletedOrders()">ğŸ”„ Actualizar</button>
      </div>
    </div>
  </div>

  <!-- Modal de detalles del pedido -->
  <div *ngIf="selectedOrder" class="modal-overlay" (click)="closeOrderDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      
      <div class="modal-header">
        <h2>ğŸ“‹ Detalles del Pedido - {{ selectedOrder.tracking_code }}</h2>
        <button class="close-btn" (click)="closeOrderDetails()">Ã—</button>
      </div>

      <div class="modal-body">
        
        <!-- InformaciÃ³n bÃ¡sica -->
        <div class="detail-section">
          <h3>ğŸ‘¤ InformaciÃ³n del Pedido</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>CÃ³digo:</label>
              <span class="tracking-code">{{ selectedOrder.tracking_code }}</span>
            </div>
            <div class="detail-item">
              <label>Tipo:</label>
              <span class="order-type-modal {{ getOrderType(selectedOrder) }}">
                {{ getOrderTypeText(selectedOrder) }}
              </span>
            </div>
            <div class="detail-item">
              <label>Cliente:</label>
              <span>{{ selectedOrder.customer_name }}</span>
            </div>
            <div class="detail-item">
              <label>TelÃ©fono:</label>
              <span>{{ selectedOrder.customer_phone || 'No proporcionado' }}</span>
            </div>
            <div class="detail-item">
              <label>Fecha:</label>
              <span>{{ getTimeAgo(selectedOrder.order_date) }}</span>
            </div>
            <div *ngIf="getOrderType(selectedOrder) === 'eat_in'" class="detail-item">
              <label>Mesa/Mesero:</label>
              <span>{{ getTableInfo(selectedOrder) }}</span>
            </div>
          </div>
        </div>

        <!-- InformaciÃ³n de pago -->
        <div class="detail-section">
          <h3>ğŸ’³ InformaciÃ³n de Pago</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>MÃ©todo:</label>
              <span>{{ getPaymentMethodText(selectedOrder.payment_method) }}</span>
            </div>
            <div class="detail-item">
              <label>Estado pago:</label>
              <span>
                <button 
                  class="payment-toggle" 
                  [class.verified]="selectedOrder.payment_verified"
                  [class.pending]="!selectedOrder.payment_verified"
                  (click)="togglePaymentStatus(selectedOrder)"
                >
                  {{ selectedOrder.payment_verified ? 'âœ… Verificado' : 'â³ Pendiente' }}
                </button>
              </span>
            </div>
            <div class="detail-item">
              <label>Total:</label>
              <span class="total-amount">${{ selectedOrder.total_amount | number:'1.2-2' }}</span>
            </div>
            
            <!-- InformaciÃ³n de efectivo -->
            <div *ngIf="selectedOrder.payment_method === 'efectivo'" class="detail-item full-width">
              <label>InformaciÃ³n Efectivo:</label>
              <div class="cash-details-modal">
                <div class="cash-amount-modal">ğŸ’µ {{ getOrderType(selectedOrder) === 'eat_in' ? 'Recibido:' : 'Paga con:' }} ${{ getCashAmount(selectedOrder) | number:'1.2-2' }}</div>
                <div [class]="getChangeAmount(selectedOrder) >= 0 ? 'change-positive' : 'change-negative'">
                  ğŸ”„ Cambio: ${{ getChangeAmount(selectedOrder) | number:'1.2-2' }}
                </div>
                <div *ngIf="getChangeAmount(selectedOrder) < 0" class="change-alert">
                  âš ï¸ El cliente no lleva suficiente dinero
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="detail-section">
          <h3>ğŸ›’ Productos ({{ getOrderItems(selectedOrder).length }})</h3>
          <div class="products-list-detailed">
            <div *ngFor="let item of getOrderItems(selectedOrder)" class="product-item-detailed">
              <div class="product-info">
                <span class="product-name">{{ item.nombre }}</span>
                <span class="product-quantity">x{{ item.cantidad }}</span>
              </div>
              <div class="product-price">${{ (item.precio * item.cantidad) | number:'1.2-2' }}</div>
            </div>
            <div class="products-total">
              <strong>Total: ${{ selectedOrder.total_amount | number:'1.2-2' }}</strong>
            </div>
          </div>
        </div>

        <!-- DirecciÃ³n - SOLO para pedidos online -->
        <div *ngIf="getOrderType(selectedOrder) === 'takeaway' && getDeliveryAddress(selectedOrder).address" 
             class="detail-section">
          <h3>ğŸ“ DirecciÃ³n de Entrega</h3>
          <div class="address-details">
            <p><strong>DirecciÃ³n:</strong> {{ getDeliveryAddress(selectedOrder).address }}</p>
            <p *ngIf="getDeliveryAddress(selectedOrder).neighborhood"><strong>Colonia:</strong> {{ getDeliveryAddress(selectedOrder).neighborhood }}</p>
            <p *ngIf="getDeliveryAddress(selectedOrder).city"><strong>Ciudad:</strong> {{ getDeliveryAddress(selectedOrder).city }}</p>
            <p *ngIf="getDeliveryAddress(selectedOrder).references">
              <strong>Referencias:</strong> {{ getDeliveryAddress(selectedOrder).references }}
            </p>
          </div>
        </div>

        <!-- Controles de estado para PEDIDOS ONLINE -->
        <div *ngIf="getOrderType(selectedOrder) === 'takeaway'" class="detail-section">
          <h3>ğŸ”„ Actualizar Estado</h3>
          <div class="status-controls">
            <button 
              *ngFor="let status of statusOptions"
              class="status-btn" 
              [class.active]="selectedOrder.status === status.value"
              [class.disabled]="selectedOrder.status === 'finalizado'"
              (click)="updateOrderStatus(selectedOrder, status.value)"
              [disabled]="selectedOrder.status === 'finalizado'"
            >
              {{ status.icon }} {{ status.label }}
            </button>
          </div>
          <p *ngIf="selectedOrder.status === 'finalizado'" class="finalized-notice">
            âš ï¸ Este pedido estÃ¡ finalizado y no puede modificarse
          </p>
        </div>

        <!-- âœ… NUEVO: Controles de estado para PEDIDOS DE MESA -->
        <div *ngIf="getOrderType(selectedOrder) === 'eat_in'" class="detail-section">
          <h3>ğŸ½ï¸ Gestionar Pedido de Mesa</h3>
          <div class="mesa-status-controls">
            
            <button 
              class="mesa-status-btn finalizar-btn" 
              [class.active]="selectedOrder.status === 'finalizado'"
              (click)="updateOrderStatus(selectedOrder, 'finalizado')">
              ğŸ Finalizar Pedido
            </button>
          </div>
          
          <div class="mesa-status-info">
            <p *ngIf="selectedOrder.status === 'en_proceso'">â³ El pedido estÃ¡ en proceso de preparaciÃ³n</p>
            <p *ngIf="selectedOrder.status === 'entregado'">âœ… Pedido entregado al cliente</p>
            <p *ngIf="selectedOrder.status === 'finalizado'" class="finalized-notice">
              âš ï¸ Este pedido estÃ¡ finalizado y no puede modificarse
            </p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-close" (click)="closeOrderDetails()">Cerrar</button>
      </div>
    </div>
  </div>
</div>